import streamlit as st
import pandas as pd
import plotly.graph_objects as go

# ------------------------------------------
# App settings
# ------------------------------------------
st.set_page_config(
    page_title="BusinessGraph Pro",
    page_icon="üìà",
    layout="wide"
)

# ------------------------------------------
# Languages
# ------------------------------------------
LANG = st.sidebar.selectbox("–¢—ñ–ª / –Ø–∑—ã–∫", ["“ö–∞–∑–∞“õ—à–∞", "–†—É—Å—Å–∫–∏–π"])

TEXT = {
    "“ö–∞–∑–∞“õ—à–∞": {
        "title": "BusinessGraph Pro",
        "author": "–ê–≤—Ç–æ—Ä: –ê—Ä–∞–ª –∞—É–¥–∞–Ω—ã ‚Ññ71 –º–µ–∫—Ç–µ–ø",
        "desc": "”®–Ω—ñ–º–¥–µ—Ä–¥—ñ“£ –∞–π–Ω—ã–º–∞–ª—ã —à—ã“ì—ã–Ω–¥–∞—Ä—ã, –±–∞“ì–∞—Å—ã –∂”ô–Ω–µ –∫”ô—Å—ñ–ø–æ—Ä—ã–Ω–Ω—ã“£ —Ç“±—Ä–∞“õ—Ç—ã —à—ã“ì—ã–Ω—ã –Ω–µ–≥—ñ–∑—ñ–Ω–¥–µ –∑–∞–ª–∞–ª—Å—ã–∑–¥—ã“õ –Ω“Ø–∫—Ç–µ—Å—ñ–Ω –µ—Å–µ–ø—Ç–µ–ø, –≥—Ä–∞—Ñ–∏–∫ —Ç“Ø—Ä—ñ–Ω–¥–µ –∫”©—Ä—Å–µ—Ç–µ—Ç—ñ–Ω –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤—Ç—ñ “õ“±—Ä–∞–ª.",
        "product_name": "”®–Ω—ñ–º –∞—Ç–∞—É—ã",
        "variable_cost": "–ê–π–Ω—ã–º–∞–ª—ã —à—ã“ì—ã–Ω (—Ç–µ“£–≥–µ)",
        "price": "–ë–∞“ì–∞—Å—ã (—Ç–µ“£–≥–µ)",
        "add_product": "”®–Ω—ñ–º “õ–æ—Å—É",
        "fixed_costs": "–¢“±—Ä–∞“õ—Ç—ã —à—ã“ì—ã–Ω (—Ç–µ“£–≥–µ)",
        "graph_title": "–ó–∞–ª–∞–ª—Å—ã–∑–¥—ã“õ –≥—Ä–∞—Ñ–∏–≥—ñ",
        "units": "”®–Ω–¥—ñ—Ä—ñ–ª–µ—Ç—ñ–Ω —Å–∞–Ω—ã",
        "break_even": "–ó–∞–ª–∞–ª—Å—ã–∑–¥—ã“õ –Ω“Ø–∫—Ç–µ—Å—ñ",
        "advice": "–ü–∞–π–¥–∞–ª—ã –∫–µ“£–µ—Å—Ç–µ—Ä",
        "save": "”®–Ω—ñ–º–¥—ñ —Å–∞“õ—Ç–∞—É"
    },
    "–†—É—Å—Å–∫–∏–π": {
        "title": "BusinessGraph Pro",
        "author": "–ê–≤—Ç–æ—Ä: –®–∫–æ–ª–∞ ‚Ññ71, –ê—Ä–∞–ª—å—Å–∫–∏–π —Ä–∞–π–æ–Ω",
        "desc": "–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Ç–æ—á–∫–∏ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑–¥–µ—Ä–∂–µ–∫, —Ü–µ–Ω—ã –∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤.",
        "product_name": "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞",
        "variable_cost": "–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã (—Ç–µ–Ω–≥–µ)",
        "price": "–¶–µ–Ω–∞ (—Ç–µ–Ω–≥–µ)",
        "add_product": "–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä",
        "fixed_costs": "–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã (—Ç–µ–Ω–≥–µ)",
        "graph_title": "–ì—Ä–∞—Ñ–∏–∫ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏",
        "units": "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥—É–∫—Ü–∏–∏",
        "break_even": "–¢–æ—á–∫–∞ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏",
        "advice": "–ü–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã",
        "save": "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
    }
}

TR = TEXT[LANG]

# ------------------------------------------
# Header
# ------------------------------------------
st.title(TR["title"])
st.caption(TR["author"])
st.write(TR["desc"])

st.markdown("---")

# ------------------------------------------
# Product input block
# ------------------------------------------
st.subheader(TR["add_product"])

if "products" not in st.session_state:
    st.session_state["products"] = []

col1, col2, col3 = st.columns([3, 2, 2])

with col1:
    name = st.text_input(TR["product_name"])
with col2:
    vcost = st.number_input(TR["variable_cost"], min_value=0.0, step=10.0, value=0.0)
with col3:
    price = st.number_input(TR["price"], min_value=0.0, step=10.0, value=0.0)

if st.button(TR["save"], type="primary"):
    if name and price > 0:
        st.session_state["products"].append(
            {"name": name, "vcost": float(vcost), "price": float(price)}
        )
        st.success("‚úî ”®–Ω—ñ–º —Ç—ñ–∑—ñ–º–≥–µ “õ–æ—Å—ã–ª–¥—ã! / –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫!")
    else:
        st.error("”®–Ω—ñ–º –∞—Ç–∞—É—ã –º–µ–Ω –±–∞“ì–∞ –º—ñ–Ω–¥–µ—Ç—Ç—ñ. / –ù–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã.")

# ------------------------------------------
# Products table
# ------------------------------------------
df = pd.DataFrame(st.session_state["products"])
if not df.empty:
    st.write("### ”®–Ω—ñ–º–¥–µ—Ä —Ç—ñ–∑—ñ–º—ñ / –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤")
    st.table(df)

st.markdown("---")

# ------------------------------------------
# Fixed costs and break-even graph
# ------------------------------------------
fixed_cost = st.number_input(
    TR["fixed_costs"], min_value=0.0, step=1000.0, value=0.0
)

if df.empty:
    st.info("–ê–ª–¥—ã–º–µ–Ω –∫–µ–º—ñ–Ω–¥–µ –±—ñ—Ä ”©–Ω—ñ–º “õ–æ—Å—ã“£—ã–∑. / –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä.")
elif fixed_cost <= 0:
    st.info("–¢“±—Ä–∞“õ—Ç—ã —à—ã“ì—ã–Ω–¥—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑. / –í–≤–µ–¥–∏—Ç–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã.")
else:
    # “ö–∞–∑—ñ—Ä –ª–æ–≥–∏–∫–∞ –±—ñ—Ä ”©–Ω—ñ–º “Ø—à—ñ–Ω; –µ–≥–µ—Ä –±—ñ—Ä–Ω–µ—à–µ—É –±–æ–ª—Å–∞, –±—ñ—Ä—ñ–Ω—à—ñ—Å—ñ–Ω –∞–ª–∞–º—ã–∑
    if len(df) > 1:
        st.warning(
            "“ö–∞–∑—ñ—Ä –∑–∞–ª–∞–ª—Å—ã–∑–¥—ã“õ –Ω“Ø–∫—Ç–µ—Å—ñ —Ç–µ–∫ –±—ñ—Ä—ñ–Ω—à—ñ ”©–Ω—ñ–º “Ø—à—ñ–Ω –µ—Å–µ–ø—Ç–µ–ª–µ–¥—ñ. "
            "–ö–µ–π—ñ–Ω –±–∞—Ä–ª—ã“õ ”©–Ω—ñ–º–¥–µ—Ä “Ø—à—ñ–Ω –∫–µ“£–µ–π—Ç—É–≥–µ –±–æ–ª–∞–¥—ã."
        )

    product = df.iloc[0]
    p = product["price"]
    vc = product["vcost"]

    if p <= vc:
        st.error(
            "–ë–∞“ì–∞ –∞–π–Ω—ã–º–∞–ª—ã —à—ã“ì—ã–Ω–Ω–∞–Ω –∂–æ“ì–∞—Ä—ã –±–æ–ª—É—ã –∫–µ—Ä–µ–∫, ”ô–π—Ç–ø–µ—Å–µ –ø–∞–π–¥–∞ —à—ã“õ–ø–∞–π–¥—ã. "
            "/ –¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã—à–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞—Ç—Ä–∞—Ç."
        )
    else:
        st.subheader(TR["graph_title"])

        break_even_units = fixed_cost / (p - vc)

        max_units = int(break_even_units * 2) if break_even_units > 0 else 10
        max_units = max(max_units, 10)

        units = list(range(0, max_units + 1))
        revenue = [u * p for u in units]
        total_cost = [fixed_cost + u * vc for u in units]

        fig = go.Figure()
        fig.add_trace(go.Scatter(x=units, y=revenue, name="–¢“Ø—Å—ñ–º / –í—ã—Ä—É—á–∫–∞"))
        fig.add_trace(go.Scatter(x=units, y=total_cost, name="–ñ–∞–ª–ø—ã —à—ã“ì—ã–Ω / –û–±—â–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã"))

        fig.add_vline(
            x=break_even_units,
            line_width=2,
            line_dash="dash",
            line_color="red",
            annotation_text=TR["break_even"],
            annotation_position="top left",
        )

        fig.update_layout(
            xaxis_title=TR["units"],
            yaxis_title="–¢–µ“£–≥–µ / –¢–µ–Ω–≥–µ",
            legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1),
        )

        st.plotly_chart(fig, use_container_width=True)

        st.success(f"**{TR['break_even']}: {break_even_units:.1f} –¥–∞–Ω–∞**")

        st.subheader(TR["advice"])
        if LANG == "“ö–∞–∑–∞“õ—à–∞":
            st.markdown(
                """
- –ë–∞“ì–∞–Ω—ã –∞–∑–¥–∞–ø –∫”©—Ç–µ—Ä—Å–µ“£—ñ–∑, –∑–∞–ª–∞–ª—Å—ã–∑–¥—ã“õ –Ω“Ø–∫—Ç–µ—Å—ñ–Ω–µ —Ç–µ–∑—ñ—Ä–µ–∫ –∂–µ—Ç–µ—Å—ñ–∑.  
- –ê–π–Ω—ã–º–∞–ª—ã —à—ã“ì—ã–Ω–¥—ã (—à–∏–∫—ñ–∑–∞—Ç, –µ“£–±–µ–∫ –∞“õ—ã) –∞–∑–∞–π—Ç—É“ì–∞ –∂“±–º—ã—Å –∂–∞—Å–∞—Å–∞“£—ã–∑, –ø–∞–π–¥–∞ ”©—Å–µ–¥—ñ.  
- –ï–≥–µ—Ä ”©–Ω–¥—ñ—Ä—ñ—Å –∫”©–ª–µ–º—ñ –∑–∞–ª–∞–ª—Å—ã–∑–¥—ã“õ –Ω“Ø–∫—Ç–µ—Å—ñ–Ω–µ–Ω —Ç”©–º–µ–Ω –±–æ–ª—Å–∞ ‚Äì –±–∏–∑–Ω–µ—Å ”ô–ª—ñ —à—ã“ì—ã–Ω–º–µ–Ω –∂“±–º—ã—Å —ñ—Å—Ç–µ–ø —Ç“±—Ä.  
                """
            )
        else:
            st.markdown(
                """
- –ù–µ–±–æ–ª—å—à–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ü–µ–Ω—ã –º–æ–∂–µ—Ç –ø—Ä–∏–±–ª–∏–∑–∏—Ç—å –≤–∞—Å –∫ —Ç–æ—á–∫–µ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏.  
- –°–Ω–∏–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞—Ç—Ä–∞—Ç (—Å—ã—Ä—å—ë, —Ç—Ä—É–¥) –ø–æ–≤—ã—à–∞–µ—Ç –ø—Ä–∏–±—ã–ª—å.  
- –ï—Å–ª–∏ –æ–±—ä—ë–º –ø—Ä–æ–¥–∞–∂ –Ω–∏–∂–µ —Ç–æ—á–∫–∏ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏ ‚Äì –±–∏–∑–Ω–µ—Å –≤—Å—ë –µ—â—ë —É–±—ã—Ç–æ—á–µ–Ω.  
                """
            )
